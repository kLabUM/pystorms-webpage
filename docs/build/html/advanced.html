
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Advanced &#8212; pystorms 1.0.0 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Contributing" href="contributing.html" />
    <link rel="prev" title="Building Custom Scenarios" href="building_scenarios.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="index.html">
<p class="title">pystorms</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="getting_started.html">
  <code class="docutils literal notranslate">
   <span class="pre">
    pystorms
   </span>
  </code>
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="scenarios.html">
  Scenarios
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="building_scenarios.html">
  Building Custom Scenarios
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="current reference internal nav-link" href="#">
  Advanced
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="contributing.html">
  Contributing
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/kLabUM/pystorms" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://pypi.org/project/pystorms/" rel="noopener" target="_blank" title="PyPI"><span><i class="fas fa-box"></i></span>
            <label class="sr-only">PyPI</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multi-processing">
   Multi-processing
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#worker">
     <code class="docutils literal notranslate">
      <span class="pre">
       worker
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#swarm">
     <code class="docutils literal notranslate">
      <span class="pre">
       swarm
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example">
     Example:
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#serial-and-parallel">
       Serial and Parallel
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pyswmm-functionality">
   <code class="docutils literal notranslate">
    <span class="pre">
     pyswmm
    </span>
   </code>
   functionality
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#defining-states">
   Defining States
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="advanced">
<h1>Advanced<a class="headerlink" href="#advanced" title="Permalink to this headline">#</a></h1>
<section id="multi-processing">
<h2>Multi-processing<a class="headerlink" href="#multi-processing" title="Permalink to this headline">#</a></h2>
<p>pystorms environments can be seamlessly adopted for multiprocessing</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pystorms</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
</pre></div>
</div>
<section id="worker">
<h3><code class="docutils literal notranslate"><span class="pre">worker</span></code><a class="headerlink" href="#worker" title="Permalink to this headline">#</a></h3>
<p>This function takes a controller as an argument, enabling us to evaluate
multiple control strategies simultaniously.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">pystorms</span><span class="o">.</span><span class="n">scenarios</span><span class="o">.</span><span class="n">gamma</span><span class="p">()</span>
    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># different controllers</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">controller</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">())</span>
        <span class="n">done</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">performance</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="swarm">
<h3><code class="docutils literal notranslate"><span class="pre">swarm</span></code><a class="headerlink" href="#swarm" title="Permalink to this headline">#</a></h3>
<p>This function maps the worker function onto multiple processors and
return the performance</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_swarm</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">processors</span><span class="p">,</span> <span class="n">jobs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate workers based on the environment and controller</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">swarm_inputs</span> <span class="o">=</span> <span class="n">config</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">swarm_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">jobs</span><span class="p">)]</span>

    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processors</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">swarm_inputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</section>
<section id="example">
<h3>Example:<a class="headerlink" href="#example" title="Permalink to this headline">#</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define two generic controllers</span>
<span class="k">def</span> <span class="nf">control_1</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">control_2</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>

<span class="c1"># Create the config file</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;controller&quot;</span><span class="p">:</span> <span class="n">control_1</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;controller&quot;</span><span class="p">:</span> <span class="n">control_2</span><span class="p">}]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">generate_swarm</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mf">15736.942557976538</span><span class="p">,</span> <span class="mf">282982.5873304134</span><span class="p">]</span>
</pre></div>
</div>
<p>Lets time it to check that the function is running on mutiple
processors. If sucessful, simulation time should be half.</p>
<section id="serial-and-parallel">
<h4>Serial and Parallel<a class="headerlink" href="#serial-and-parallel" title="Permalink to this headline">#</a></h4>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">worker</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">worker</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>15.1 s ± 434 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">generate_swarm</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>10.8 s ± 42.6 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
<p>Thats 3 seconds more than what i expected. This might be due the
initialization cost. This should go down as the number of simulations
increase.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">worker</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">worker</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">worker</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">worker</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">worker</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">worker</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>44.1 s ± 79.6 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">generate_swarm</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>10.8 s ± 68.9 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">generate_swarm</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>11.1 s ± 451 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
<p>Thats consistent!</p>
</section>
</section>
</section>
<section id="pyswmm-functionality">
<h2><code class="docutils literal notranslate"><span class="pre">pyswmm</span></code> functionality<a class="headerlink" href="#pyswmm-functionality" title="Permalink to this headline">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">pystorms</span></code> is built on <code class="docutils literal notranslate"><span class="pre">pyswmm</span></code>. It uses <code class="docutils literal notranslate"><span class="pre">pyswmm</span></code> as its back-end
for interacting with EPA-SWMM’s computational engine. Hence, all the
functionality in <code class="docutils literal notranslate"><span class="pre">pyswmm</span></code> is inherently available in <code class="docutils literal notranslate"><span class="pre">pystorms</span></code>.
<code class="docutils literal notranslate"><span class="pre">pystorms</span></code> by defaults supports a subset of the states though its API.
These subsets of states (i.e. depth, flows, inflows) were chosen to
represent frequently used parameters for making control decisions. Refer
to the documentation on states for more details on the supported
parameters. <code class="docutils literal notranslate"><span class="pre">pystorms</span></code> architecture is designed to enable users easy
access to all the existing pyswmm functionality.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pystorms</span>
<span class="kn">import</span> <span class="nn">pyswmm.toolkitapi</span> <span class="k">as</span> <span class="nn">tkai</span>
</pre></div>
</div>
<p>This example demonstrates how pyswmm functionality can be invoked from
<cite>pystorms</cite>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">pystorms</span><span class="o">.</span><span class="n">scenarios</span><span class="o">.</span><span class="n">theta</span><span class="p">()</span>
</pre></div>
</div>
<p>All function calls being used in the environment for populating state
vector are listed in the <code class="docutils literal notranslate"><span class="pre">env.env.methods</span></code> dictionary.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">methods</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;depthN&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">environment</span><span class="o">.</span><span class="n">_getNodeDepth</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">pystorms</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">environment</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x11929d690</span><span class="o">&gt;&gt;</span><span class="p">,</span>
 <span class="s1">&#39;depthL&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">environment</span><span class="o">.</span><span class="n">_getLinkDepth</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">pystorms</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">environment</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x11929d690</span><span class="o">&gt;&gt;</span><span class="p">,</span>
 <span class="s1">&#39;flow&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">environment</span><span class="o">.</span><span class="n">_getLinkFlow</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">pystorms</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">environment</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x11929d690</span><span class="o">&gt;&gt;</span><span class="p">,</span>
 <span class="s1">&#39;flooding&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">environment</span><span class="o">.</span><span class="n">_getNodeFlooding</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">pystorms</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">environment</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x11929d690</span><span class="o">&gt;&gt;</span><span class="p">,</span>
 <span class="s1">&#39;inflow&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">environment</span><span class="o">.</span><span class="n">_getNodeInflow</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">pystorms</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">environment</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x11929d690</span><span class="o">&gt;&gt;</span><span class="p">,</span>
 <span class="s1">&#39;pollutantN&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">environment</span><span class="o">.</span><span class="n">_getNodePollutant</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">pystorms</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">environment</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x11929d690</span><span class="o">&gt;&gt;</span><span class="p">,</span>
 <span class="s1">&#39;pollutantL&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">environment</span><span class="o">.</span><span class="n">_getLinkPollutant</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">pystorms</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">environment</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x11929d690</span><span class="o">&gt;&gt;</span><span class="p">}</span>
</pre></div>
</div>
<p>Let us say, we want to use volume as a state. All we have to do is add
the function call reading volume to the dict.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_getNodeVolume</span><span class="p">(</span><span class="n">NodeID</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">getNodeResult</span><span class="p">(</span><span class="n">NodeID</span><span class="p">,</span> <span class="n">tkai</span><span class="o">.</span><span class="n">NodeResults</span><span class="o">.</span><span class="n">newVolume</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p><cite>env</cite> refers to the scenario being initialized.
For example, if the scenario was initialized as <cite>sce</cite> the first class in the return statement would be <cite>sce</cite>. env in <cite>&lt;scenario class&gt;.env</cite> refers to the environment class used to communicate with pyswmm/EPA-SWMM.
<cite>sim._model</cite> refers to the EPA-SWMM simulation initialized by invoking the scenario class.
<cite>getNodeResult</cite> is the functional call that queries the volume from the EPA-SWMM.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">methods</span><span class="p">[</span><span class="s2">&quot;volumeN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_getNodeVolume</span>
</pre></div>
</div>
<p>Lets add volume to the state vector</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;P1&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;P2&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;P1&#39;</span><span class="p">,</span> <span class="s1">&#39;volumeN&#39;</span><span class="p">))</span>
<span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;P2&#39;</span><span class="p">,</span> <span class="s1">&#39;volumeN&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p><em>NOTE:</em> Arguments to the volume function are tuple appended to the config dict. Refer to <a class="reference external" href="https://github.com/kLabUM/pystorms/blob/ffa3564ef5f80811ca246b10ffeb0e38f36befdb/pystorms/environment.py#L74">environment.py</a> for more details on how state vector is populated.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;P1&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;P2&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;P1&#39;</span><span class="p">,</span> <span class="s1">&#39;volumeN&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;P2&#39;</span><span class="p">,</span> <span class="s1">&#39;volumeN&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>Now when <code class="docutils literal notranslate"><span class="pre">env.state()</span></code> is called, it returns all both depth and volume
in nodes</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
</pre></div>
</div>
<p>Refer to pyswmm documentation for details on the all supported
parameters.</p>
<section id="id1">
<h3>Example<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pystorms</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pyswmm.toolkitapi</span> <span class="k">as</span> <span class="nn">tkai</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="c1"># Create the function call for reading volume</span>
<span class="k">def</span> <span class="nf">getNodeVolume</span><span class="p">(</span><span class="n">NodeID</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">getNodeResult</span><span class="p">(</span><span class="n">NodeID</span><span class="p">,</span> <span class="n">tkai</span><span class="o">.</span><span class="n">NodeResults</span><span class="o">.</span><span class="n">newVolume</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>


<span class="c1"># Initalize scenario</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">pystorms</span><span class="o">.</span><span class="n">scenarios</span><span class="o">.</span><span class="n">theta</span><span class="p">()</span>

<span class="c1"># Update the methods dict</span>
<span class="n">env</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">methods</span><span class="p">[</span><span class="s2">&quot;volumeN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNodeVolume</span>
<span class="c1"># Update state vector</span>
<span class="n">env</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;P1&quot;</span><span class="p">,</span> <span class="s2">&quot;volumeN&quot;</span><span class="p">))</span>
<span class="n">env</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;P2&quot;</span><span class="p">,</span> <span class="s2">&quot;volumeN&quot;</span><span class="p">))</span>

<span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">()</span>
    <span class="n">done</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;depthP1&quot;</span><span class="p">,</span> <span class="s2">&quot;depthP2&quot;</span><span class="p">,</span> <span class="s2">&quot;volumeP1&quot;</span><span class="p">,</span> <span class="s2">&quot;volumeP2&quot;</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="defining-states">
<h2>Defining States<a class="headerlink" href="#defining-states" title="Permalink to this headline">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pystorms</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
<p>In scenario gamma, states are defined as the depths in the basins of the network.
If needed custom states can be defined by the users, overwriting or
appending to the default states provided in the library. Consider the following example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">pystorms</span><span class="o">.</span><span class="n">scenarios</span><span class="o">.</span><span class="n">gamma</span><span class="p">()</span>
</pre></div>
</div>
<p>States defined in gamma scenario can be queried as follows,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;11&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>Appending the state list with the new state choice would update the
state vector returned by the <code class="docutils literal notranslate"><span class="pre">env.state()</span></code> function.</p>
<p>For example, consider the case when we want to add outflow from the 4th
basin to the state.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;O4&quot;</span><span class="p">,</span> <span class="s2">&quot;flow&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;11&#39;</span><span class="p">,</span> <span class="s1">&#39;depthN&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;O4&#39;</span><span class="p">,</span> <span class="s1">&#39;flow&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>When we run the simulation, <code class="docutils literal notranslate"><span class="pre">env.state()</span></code> function should return a
vector of length 12.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">state</span><span class="p">()</span>
    <span class="n">done</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">11</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">12</span>
</pre></div>
</div>
<p>Users are not limited to the flows in the network. They are allowed to
access any value computed by the swmm network.</p>
<dl class="simple">
<dt>Supported state queries:</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">depthN</span></code>     : Depth in nodes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">depthL</span></code>     : Depth in links</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flow</span></code>       : Flow in links/orifices/weir</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flooding</span></code>   : Flooding in nodes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pollutantN</span></code> : Pollutant in nodes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pollutantL</span></code> : Pollutant in links</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inflow</span></code>     : Inflow into nodes</p></li>
</ul>
</dd>
</dl>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="building_scenarios.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Building Custom Scenarios</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="contributing.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Contributing</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>